
[include cartographer.cfg]
[include ebb36.cfg]
[include steppers.cfg]
[include x.cfg]
[include bedfans.cfg]
[include carto_calibrate.cfg]
[include temp.cfg]
[include motorsync.cfg]
[include mainsail.cfg]
[include KAMP_Settings.cfg]
[include timelapse.cfg]
[include macros.cfg]
#[include tmc_autotune.cfg]
[include autospeed.cfg]
[include testspeed.cfg]
#[include grease.cfg]
[include stealthburner_led.cfg]
[nozzle_is.cfg]
#include reshelper.cfg]

[mcu]
canbus_uuid: 0bfa866d29fd

[printer]
kinematics: corexy
max_velocity: 450
max_accel: 24000             #Max 4000
max_z_velocity: 15         #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 100
minimum_cruise_ratio: 0.5				# Default 0.5
square_corner_velocity: 15.0

[input_shaper]
shaper_freq_x: 104.8
shaper_type_x: mzv
damping_ratio_x: 0.032
shaper_freq_y: 92.0
shaper_type_y: mzv
damping_ratio_y: 0.078

[extruder]
step_pin: ebb36: PD0
dir_pin: ebb36: PD1
sensor_type: ATC Semitec 104GT-2
#sensor_type: EPCOS 100K B57560G104F 
sensor_pin: ebb36: TH0 #PA3 
enable_pin: !ebb36: PD2
heater_pin: ebb36: HE0
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100 8.255
#rotation_distance: 4.5449275368 # 4.63768116 #34.778 #22.225371 #22.67895 #52.558275 #52.25 #53.59 #22.6789511  #22.23 #Bondtech 5mm Drive Gears
rotation_distance: 47.088
gear_ratio: 9:1 #7.5:1 #50:10 #44:10 37:17 #50:17             # BMG Gear Ratio
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
max_extrude_only_distance: 101 
max_extrude_only_velocity: 120 
min_temp: -20
max_temp: 300
min_extrude_temp: 170
pressure_advance: 0.052 #0.042
pressure_advance_smooth_time: 0.03
max_extrude_cross_section: 5
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 270

##  E0 on MOTOR6
[tmc2209 extruder]
uart_pin: ebb36: PA15
interpolate: true
run_current: 0.85
sense_resistor: 0.110
stealthchop_threshold: 0
driver_TBL: 0 
driver_HEND: 6 
driver_HSTRT: 7 
driver_TOFF: 4

[heater_bed]
##  SSR Pin - HE1
##  Thermistor - TB
heater_pin: PA3
sensor_type: Generic 3950
sensor_pin: PF3
##  Adjust max_power so it doesn't exceed the SSR rating. The Omron G3NA-210B-DC5 SSR is rated at 4 amps without a heatsink.
##  The formula is "4 / (Wattage_of_bed_heater / Mains_voltage) = max_power"
##  If max_power is greater than 1.0, use 1.0
max_power: 1.0 # 0.8
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[idle_timeout]
timeout: 1800

[z_tilt]

z_positions:
   -50, 18
   175, 398
   400, 18
points:
   30, 5
   175, 295
   320, 5

speed: 300
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0025


[board_pins]
  aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,
  
    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


[gcode_macro PRINT_START]
gcode:
    STATUS_HOMING
    LOWERCURRENT
    G28
    RESETCURRENT
    SYNC_MOTORS
    STATUS_READY
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
    CARTOGRAPHER_TOUCH
    M190 S{ params.BED }       ; Wait for bed to get to target temperature.
    M117 Preheating nozzle
    M109 S150                  ; Wait for nozzle to heat to 150C - soften filament, but no oozing.
    M107                       ; Print fan off
    #G1 X175 Y175 Z50 F5000.0
    STATUS_HEATING
    M117 Heating nozzle
    M109 S{ params.EXTRUDER }  ; Wait for nozzle to get to target temperature.
    G90                 ; Absolute coordinates.
    M83                 ; Relative extruder mode.
    STATUS_CLEANING
    #clean_nozzle
    STATUS_READY
    set_nozzle_leds_on
    #SET_FAN_SPEED FAN=Nevermore SPEED=0.7
    BED_MESH_PROFILE LOAD="default"    
    # G1 Z20 F3000                   ; move nozzle away from bed
    # G1 X10 Y20 Z0.3 F5000.0 ; move to start-line position
    # G1 X10 Y200.0 Z0.3 F1500.0 E15 ; draw 1st line
    # G1 X11 Y200.0 Z0.3 F5000.0 ; move to side a little
    # G1 X11 Y20 Z0.3 F1500.0 E30 ; draw 2nd line
    # G1 E27 F3000 ; retract filament 3mm
    # G92 E0 ; reset extruder
    # G1 Z1.0 F3000 ; move z up little to prevent scratching of surface
    LINE_PURGE

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-2.0 F3600                 ; retract filament
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    BED_MESH_CLEAR

    # The purpose of the SAVE_GCODE_STATE/RESTORE_GCODE_STATE
    # command pair is to restore the printer's coordinate system
    # and speed settings since the commands above change them.
    # However, to prevent any accidental, unintentional toolhead
    # moves when restoring the state, explicitly set MOVE=0.
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 27.694
#*# pid_ki = 4.013
#*# pid_kd = 47.774
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 5750
#*# scanner_touch_speed = 3
#*#
#*# [motors_sync]
#*# steps_model_x = exponential,
#*# 	15256962.486568322,
#*# 	0.0006129305720977749,
#*# 	-15257239.94693789
#*# steps_model_y = exponential,
#*# 	15256962.486568322,
#*# 	0.0006129305720977749,
#*# 	-15257239.94693789
#*#
#*# [scanner model default]
#*# model_coef = 1.256879125558131,
#*# 	1.5589857157503313,
#*# 	0.7410989850571962,
#*# 	0.2948581958199403,
#*# 	0.5462170949088081,
#*# 	0.9103879244058275,
#*# 	-0.48320802111176564,
#*# 	-1.0666112910912309,
#*# 	0.5881811287197094,
#*# 	0.7543872561594334
#*# model_domain = 2.8345956141035307e-07,3.3121723842662494e-07
#*# model_range = 0.200000,5.100000
#*# model_temp = 28.253861
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.028692, 0.029452, 0.032976, 0.033449, 0.035068, 0.035990, 0.037032, 0.040674, 0.041720, 0.045110, 0.048649, 0.051074, 0.052155, 0.052988, 0.054059, 0.055268, 0.053917, 0.052790, 0.049956, 0.046789, 0.043495, 0.037507, 0.032981, 0.029865, 0.025806, 0.021576, 0.019386, 0.020106, 0.020900, 0.021050, 0.021787, 0.021912, 0.021452, 0.020822, 0.018963, 0.016922, 0.016833, 0.017655, 0.020124, 0.020363, 0.021155, 0.025813, 0.026885, 0.028914, 0.031435, 0.031978, 0.034669, 0.037092, 0.037422, 0.040799
#*# 	0.023516, 0.025201, 0.029391, 0.030468, 0.032159, 0.033177, 0.034771, 0.037423, 0.040623, 0.045379, 0.047189, 0.050423, 0.052686, 0.053671, 0.054680, 0.054810, 0.053809, 0.051576, 0.049037, 0.046239, 0.040930, 0.036459, 0.033208, 0.028331, 0.022909, 0.020936, 0.019081, 0.020739, 0.021186, 0.021669, 0.023297, 0.022512, 0.021616, 0.021778, 0.020862, 0.018467, 0.018860, 0.021274, 0.022073, 0.023613, 0.026494, 0.029103, 0.030394, 0.032002, 0.034961, 0.036014, 0.037146, 0.039064, 0.040478, 0.044452
#*# 	0.019353, 0.020592, 0.025122, 0.026544, 0.027866, 0.030257, 0.031316, 0.034192, 0.036598, 0.042684, 0.045995, 0.049293, 0.051603, 0.053693, 0.054258, 0.053948, 0.053121, 0.051620, 0.049154, 0.046075, 0.041323, 0.035745, 0.032046, 0.027981, 0.022966, 0.019822, 0.016281, 0.017844, 0.019231, 0.017469, 0.020109, 0.019712, 0.018713, 0.020397, 0.020126, 0.018976, 0.019245, 0.021753, 0.021820, 0.024381, 0.027155, 0.028441, 0.030827, 0.031986, 0.032586, 0.034799, 0.037044, 0.038135, 0.039570, 0.043028
#*# 	0.015816, 0.017574, 0.020599, 0.022437, 0.025105, 0.027440, 0.030398, 0.033559, 0.037621, 0.042871, 0.045897, 0.049094, 0.050888, 0.051933, 0.052921, 0.052496, 0.051283, 0.049498, 0.047367, 0.043271, 0.037767, 0.032429, 0.029556, 0.025166, 0.020770, 0.017821, 0.015304, 0.016750, 0.016555, 0.016402, 0.018499, 0.019640, 0.020065, 0.020014, 0.020832, 0.020585, 0.021100, 0.023498, 0.025073, 0.026696, 0.029424, 0.031585, 0.033952, 0.033961, 0.034683, 0.036985, 0.036874, 0.038818, 0.041448, 0.045075
#*# 	0.011906, 0.016349, 0.019601, 0.019316, 0.021452, 0.024781, 0.028190, 0.032638, 0.035871, 0.040950, 0.045531, 0.048019, 0.049910, 0.052710, 0.053205, 0.052310, 0.051354, 0.049200, 0.046281, 0.041886, 0.038028, 0.032329, 0.029221, 0.025930, 0.020156, 0.016663, 0.014743, 0.013707, 0.013579, 0.013629, 0.014507, 0.016269, 0.017916, 0.017651, 0.019072, 0.020175, 0.021780, 0.023579, 0.025304, 0.027477, 0.029169, 0.031261, 0.033745, 0.034647, 0.034364, 0.035324, 0.036706, 0.038053, 0.040299, 0.043793
#*# 	0.008481, 0.011903, 0.013552, 0.015257, 0.019065, 0.022284, 0.026349, 0.030484, 0.034920, 0.039432, 0.043242, 0.044988, 0.047984, 0.049926, 0.049972, 0.049852, 0.047914, 0.043925, 0.042741, 0.038740, 0.033806, 0.029213, 0.026611, 0.021835, 0.018230, 0.015095, 0.013997, 0.012505, 0.011824, 0.013511, 0.013697, 0.015562, 0.016968, 0.017601, 0.019574, 0.021401, 0.023363, 0.025284, 0.027106, 0.028381, 0.031442, 0.031825, 0.033614, 0.034634, 0.035763, 0.036429, 0.036834, 0.038754, 0.042689, 0.047739
#*# 	0.006394, 0.009975, 0.012242, 0.013391, 0.015546, 0.019392, 0.023354, 0.026878, 0.032364, 0.036181, 0.040190, 0.042273, 0.044326, 0.047095, 0.046836, 0.046246, 0.045468, 0.041301, 0.038377, 0.036181, 0.031781, 0.027059, 0.024108, 0.019722, 0.016595, 0.013261, 0.011935, 0.010902, 0.008369, 0.010395, 0.010981, 0.011380, 0.014958, 0.015746, 0.017534, 0.020259, 0.021955, 0.023974, 0.026026, 0.027771, 0.029562, 0.030306, 0.031353, 0.032994, 0.034397, 0.034820, 0.036192, 0.037522, 0.039647, 0.043666
#*# 	0.006215, 0.007045, 0.009175, 0.011882, 0.014295, 0.017384, 0.020367, 0.024371, 0.029419, 0.033883, 0.036404, 0.039537, 0.041296, 0.042045, 0.042424, 0.041971, 0.039768, 0.036597, 0.035073, 0.032810, 0.027375, 0.023537, 0.021622, 0.018212, 0.015033, 0.011456, 0.012223, 0.010769, 0.009265, 0.012530, 0.011965, 0.013172, 0.016019, 0.017533, 0.019912, 0.021398, 0.022544, 0.025215, 0.026818, 0.028389, 0.031090, 0.031038, 0.031285, 0.032961, 0.035738, 0.036344, 0.037180, 0.038932, 0.039966, 0.046311
#*# 	-0.000658, 0.004604, 0.006125, 0.009062, 0.010902, 0.013475, 0.016423, 0.020899, 0.024631, 0.027494, 0.031677, 0.034415, 0.035394, 0.037150, 0.036910, 0.035749, 0.034217, 0.033346, 0.030471, 0.027070, 0.024846, 0.021403, 0.017558, 0.015431, 0.012638, 0.008923, 0.008969, 0.009310, 0.006565, 0.009084, 0.009681, 0.010380, 0.013012, 0.013587, 0.017227, 0.018093, 0.020291, 0.022187, 0.023583, 0.026103, 0.027362, 0.028172, 0.029305, 0.029283, 0.032031, 0.032926, 0.034579, 0.037288, 0.039093, 0.041753
#*# 	-0.003640, -0.000303, 0.001836, 0.003633, 0.005785, 0.008049, 0.012040, 0.014580, 0.018668, 0.021965, 0.025027, 0.026962, 0.028641, 0.029809, 0.029080, 0.028583, 0.027115, 0.026378, 0.024051, 0.020809, 0.019305, 0.017133, 0.013504, 0.012231, 0.010345, 0.007016, 0.008778, 0.008703, 0.005596, 0.008059, 0.007953, 0.010158, 0.011994, 0.013402, 0.016580, 0.018256, 0.020457, 0.021568, 0.024715, 0.025368, 0.025888, 0.027642, 0.027901, 0.029117, 0.031920, 0.032264, 0.033128, 0.038125, 0.040501, 0.043755
#*# 	-0.009959, -0.005254, -0.001270, 0.001178, 0.001866, 0.005037, 0.008690, 0.010500, 0.013148, 0.017115, 0.020150, 0.021428, 0.023245, 0.024267, 0.024370, 0.023812, 0.022748, 0.022269, 0.019973, 0.017457, 0.015641, 0.013926, 0.010813, 0.009385, 0.008288, 0.005446, 0.005799, 0.006509, 0.003968, 0.004841, 0.004405, 0.006342, 0.009129, 0.008705, 0.012593, 0.013849, 0.016487, 0.017375, 0.019969, 0.022027, 0.021924, 0.024640, 0.025396, 0.027267, 0.029305, 0.030213, 0.031482, 0.034501, 0.039667, 0.043179
#*# 	-0.013042, -0.009273, -0.006254, -0.004344, -0.001935, -0.000164, 0.002984, 0.005920, 0.008982, 0.012001, 0.014244, 0.016119, 0.017613, 0.018340, 0.017907, 0.017872, 0.017707, 0.016200, 0.015983, 0.013977, 0.012383, 0.009733, 0.008346, 0.008013, 0.006542, 0.005511, 0.005337, 0.004520, 0.004425, 0.005888, 0.005112, 0.007645, 0.007762, 0.009194, 0.011802, 0.012131, 0.015028, 0.015856, 0.018690, 0.020412, 0.021626, 0.024301, 0.025534, 0.028117, 0.030772, 0.031957, 0.032150, 0.035347, 0.040100, 0.045735
#*# 	-0.017405, -0.012386, -0.010339, -0.008807, -0.006730, -0.003674, -0.000554, 0.001208, 0.004242, 0.007713, 0.009579, 0.010658, 0.011515, 0.012731, 0.012314, 0.011955, 0.012088, 0.011931, 0.011992, 0.010289, 0.008129, 0.007558, 0.005623, 0.004688, 0.004693, 0.002407, 0.001323, 0.001075, 0.002072, 0.002954, 0.003475, 0.004632, 0.005290, 0.005989, 0.008191, 0.008967, 0.011321, 0.012557, 0.015137, 0.016984, 0.018651, 0.021787, 0.023707, 0.027823, 0.029453, 0.031544, 0.033576, 0.034671, 0.038630, 0.043494
#*# 	-0.018544, -0.016163, -0.013215, -0.010067, -0.007757, -0.004804, -0.002934, -0.000787, 0.003196, 0.005538, 0.006356, 0.008470, 0.008820, 0.009496, 0.010584, 0.010817, 0.011672, 0.011959, 0.012117, 0.011309, 0.009558, 0.008476, 0.007966, 0.006524, 0.005355, 0.004510, 0.004058, 0.004391, 0.005333, 0.006430, 0.007774, 0.007948, 0.008581, 0.010017, 0.010534, 0.012199, 0.014661, 0.016884, 0.019961, 0.021503, 0.024620, 0.027060, 0.028904, 0.033280, 0.035490, 0.036628, 0.039435, 0.041795, 0.044776, 0.049753
#*# 	-0.023882, -0.020208, -0.016490, -0.013398, -0.012128, -0.008736, -0.005572, -0.004570, -0.001609, 0.000751, 0.002240, 0.003928, 0.004104, 0.005502, 0.005951, 0.005506, 0.007039, 0.007871, 0.007256, 0.006378, 0.006474, 0.005360, 0.004975, 0.002762, 0.001060, 0.001361, -0.000029, 0.000169, 0.002047, 0.002584, 0.003722, 0.004156, 0.005430, 0.006393, 0.006888, 0.007775, 0.010604, 0.013220, 0.017254, 0.019614, 0.021953, 0.024069, 0.026221, 0.030105, 0.032594, 0.034845, 0.038574, 0.041223, 0.043904, 0.047371
#*# 	-0.026376, -0.023836, -0.019892, -0.017790, -0.015082, -0.012168, -0.010639, -0.008510, -0.006043, -0.003513, -0.003090, -0.001874, -0.000101, -0.000229, 0.000439, 0.001676, 0.001966, 0.003745, 0.004009, 0.004193, 0.003910, 0.004556, 0.002610, 0.000129, -0.000075, -0.000156, -0.000657, -0.000238, 0.000937, 0.001827, 0.003078, 0.003907, 0.005086, 0.006870, 0.008568, 0.010236, 0.010562, 0.013885, 0.019057, 0.020569, 0.023952, 0.025680, 0.028043, 0.031156, 0.034945, 0.038037, 0.039076, 0.043364, 0.046675, 0.050747
#*# 	-0.031639, -0.024522, -0.022245, -0.019346, -0.017949, -0.015121, -0.012183, -0.011357, -0.009782, -0.006031, -0.004849, -0.004546, -0.003602, -0.002719, -0.001947, -0.001190, -0.000111, 0.001329, 0.002454, 0.002634, 0.002729, 0.002007, 0.001774, -0.001545, -0.003415, -0.002572, -0.002924, -0.002796, -0.001826, -0.001408, 0.000021, 0.001391, 0.003109, 0.005245, 0.006915, 0.009665, 0.010531, 0.012197, 0.016495, 0.019893, 0.021862, 0.024785, 0.028094, 0.031124, 0.034866, 0.038325, 0.040122, 0.043640, 0.046372, 0.050036
#*# 	-0.032387, -0.028403, -0.024436, -0.022102, -0.019597, -0.017185, -0.015220, -0.013607, -0.011265, -0.008416, -0.008077, -0.007140, -0.006178, -0.004959, -0.004105, -0.001825, -0.000362, 0.001277, 0.002658, 0.003413, 0.003173, 0.003021, 0.001579, -0.001928, -0.003207, -0.003205, -0.003056, -0.002070, -0.001307, -0.000190, 0.002182, 0.003382, 0.004956, 0.006804, 0.008442, 0.012084, 0.013523, 0.016511, 0.020253, 0.022293, 0.026362, 0.028590, 0.031401, 0.035100, 0.038968, 0.040583, 0.042754, 0.047059, 0.049145, 0.054821
#*# 	-0.033702, -0.029793, -0.026811, -0.022052, -0.021328, -0.018493, -0.015778, -0.014834, -0.013124, -0.010643, -0.008775, -0.009189, -0.007509, -0.005465, -0.004720, -0.003376, -0.001932, 0.000987, 0.001557, 0.003013, 0.003124, 0.003228, 0.001830, -0.001658, -0.002781, -0.004394, -0.004452, -0.003712, -0.002699, -0.002588, -0.000378, 0.001758, 0.004237, 0.006708, 0.007415, 0.011316, 0.013795, 0.016022, 0.019310, 0.021962, 0.024766, 0.028102, 0.030973, 0.034354, 0.037725, 0.040669, 0.043571, 0.047813, 0.051948, 0.056520
#*# x_count = 50
#*# y_count = 19
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 74.259016
#*# max_x = 240.0
#*# min_y = 141.694096
#*# max_y = 198.0
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 58.007
#*# pid_ki = 1.943
#*# pid_kd = 432.876
