[respond]
[include chopper_tune.cfg]
[include cartographer.cfg]
[include ebb36.cfg]
[include steppers.cfg]
[include x.cfg]
[include bedfans.cfg]
[include carto_calibrate.cfg]
[include temp.cfg]
[include motorsync.cfg]
[include autospeed.cfg]
[include mainsail.cfg]
[include KAMP_Settings.cfg]
[include timelapse.cfg]
[include macros.cfg]
[include tmc_autotune.cfg]
[include autospeed.cfg]
[include testspeed.cfg]
[include grease.cfg]
[include stealthburner_led.cfg]
#[include nis.cfg]
[include reshelper.cfg]
#[include nw.cfg]
#[iniclude sfs.cfg]

[mcu]
canbus_uuid: 0bfa866d29fd

[printer]
kinematics: corexy
max_velocity: 1000
max_accel: 30000             #Max 4000
max_z_velocity: 50         #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 400
minimum_cruise_ratio: 0.5				# Default 0.5
square_corner_velocity: 50.0

[input_shaper]
shaper_freq_x: 107.4
shaper_type_x: mzv
damping_ratio_x: 0.043
shaper_freq_y: 86.0
shaper_type_y: mzv
damping_ratio_y: 0.079

[extruder]
step_pin: ebb36: PD0
dir_pin: !ebb36: PD1
#sensor_type: ATC Semitec 104GT-2
sensor_type: EPCOS 100K B57560G104F 
sensor_pin: ebb36: TH0 #PA3 
enable_pin: !ebb36: PD2
heater_pin: ebb36: HE0
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100 8.255
#rotation_distance: 4.5449275368 # 4.63768116 #34.778 #22.225371 #22.67895 #52.558275 #52.25 #53.59 #22.6789511  #22.23 #Bondtech 5mm Drive Gears
rotation_distance: 22.23 #47.088 #4.637 #
gear_ratio: 50:10 #9:1 #7.5:1 #50:10 #44:10 37:17 #50:17             # BMG Gear Ratio
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.500
filament_diameter: 1.75
max_extrude_only_distance: 500
max_extrude_only_velocity: 120 
min_temp: -20
max_temp: 300
min_extrude_temp: 170
pressure_advance: 0.07 #0.052 #0.042
pressure_advance_smooth_time: 0.04
max_extrude_cross_section: 5
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982

##  E0 on MOTOR6
[tmc2209 extruder]
uart_pin: ebb36: PA15
interpolate: true
run_current: 0.85
sense_resistor: 0.110
stealthchop_threshold: 0
driver_TBL: 0 
driver_HEND: 6 
driver_HSTRT: 7 
driver_TOFF: 4

[heater_bed]
heater_pin: PA3
sensor_type: Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[idle_timeout]
timeout: 1800

[z_tilt]

z_positions:
   -50, 18
   175, 398
   400, 18
points:
   30, 5
   175, 295
   320, 5

speed: 300
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0025


[board_pins]
  aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,
  
    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


[gcode_macro PRINT_START]
gcode:
    STATUS_HOMING
    LOWERCURRENT
    G28
    RESETCURRENT
    SYNC_MOTORS
    STATUS_READY
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
    CARTOGRAPHER_TOUCH
    M190 S{ params.BED }       ; Wait for bed to get to target temperature.
    M117 Preheating nozzle
    M109 S150                  ; Wait for nozzle to heat to 150C - soften filament, but no oozing.
    M107                       ; Print fan off
    #G1 X175 Y175 Z50 F5000.0
    STATUS_HEATING
    M117 Heating nozzle
    M109 S{ params.EXTRUDER }  ; Wait for nozzle to get to target temperature.
    G90                 ; Absolute coordinates.
    M83                 ; Relative extruder mode.
    STATUS_CLEANING
    #clean_nozzle
    STATUS_READY
    set_nozzle_leds_on
    #SET_FAN_SPEED FAN=Nevermore SPEED=0.7
    BED_MESH_PROFILE LOAD="default"    
    # G1 Z20 F3000                   ; move nozzle away from bed
    # G1 X10 Y20 Z0.3 F5000.0 ; move to start-line position
    # G1 X10 Y200.0 Z0.3 F1500.0 E15 ; draw 1st line
    # G1 X11 Y200.0 Z0.3 F5000.0 ; move to side a little
    # G1 X11 Y20 Z0.3 F1500.0 E30 ; draw 2nd line
    # G1 E27 F3000 ; retract filament 3mm
    # G92 E0 ; reset extruder
    # G1 Z1.0 F3000 ; move z up little to prevent scratching of surface
    LINE_PURGE

[gcode_macro PRINT_END]
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-11.0 F3600                 ; retract filament
    TURN_OFF_HEATERS
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M84
    M107                                     ; turn off fan
    BED_MESH_CLEAR
    SET_PIN PIN=caselight VALUE=0.20
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0

[danger_options]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 22.030
#*# pid_ki = 2.149
#*# pid_kd = 56.455
#*# pid_version = 1
#*# pid_target = 260.00
#*# pid_tolerance = 0.0200
#*#
#*# [motors_sync]
#*# steps_model_x = quadratic,
#*# 	-970.6457968983249,
#*# 	25991.84731691398,
#*# 	2115.5684230633683
#*# steps_model_y = quadratic,
#*# 	-970.6457968983249,
#*# 	25991.84731691398,
#*# 	2115.5684230633683
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.904
#*# pid_ki = 1.903
#*# pid_kd = 425.357
#*# pid_version = 1
#*# pid_target = 110.00
#*# pid_tolerance = 0.0200
#*#
#*# [scanner model default]
#*# model_coef = 1.3298066073602204,
#*# 	1.7598740351988222,
#*# 	0.7808963384550458,
#*# 	0.3434199077517799,
#*# 	0.36403543004543365,
#*# 	0.4887856968236885,
#*# 	-0.19788411286651655,
#*# 	-0.44585195548222745,
#*# 	0.2731347255427219,
#*# 	0.30600674020468244
#*# model_domain = 3.2027902198086696e-07,3.359329681963402e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 38.426399
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.1.0
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 2250
#*# scanner_touch_speed = 3
#*# scanner_touch_z_offset = 0.070
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  0.014380, 0.010735, 0.010405, 0.011027, 0.007495, 0.001640, 0.000548, -0.000624, -0.003572, -0.001630, -0.001422, 0.000268, 0.001290, 0.002422, 0.006025, 0.009884, 0.010715, 0.012570, 0.016953
#*# 	  0.009462, 0.010126, 0.007378, 0.004305, 0.003713, 0.001047, 0.005756, 0.003479, -0.000495, 0.003641, 0.004521, 0.005110, 0.005490, 0.008986, 0.013516, 0.008699, 0.015399, 0.021440, 0.023028
#*# 	  0.011163, 0.005813, 0.009524, 0.008913, 0.000381, 0.001916, 0.003716, 0.002935, 0.001337, 0.003433, 0.006770, 0.004855, 0.004689, 0.008906, 0.011905, 0.013624, 0.014336, 0.017761, 0.025335
#*# 	  0.004665, 0.005201, 0.002701, 0.001119, -0.000648, 0.000841, 0.004251, 0.002090, 0.001143, 0.004431, 0.005303, 0.005809, 0.006531, 0.009345, 0.014105, 0.010912, 0.017062, 0.023715, 0.026793
#*# 	  0.006057, 0.002455, 0.006109, 0.005415, 0.000090, 0.000331, 0.002190, 0.003830, 0.002177, 0.003645, 0.007579, 0.004702, 0.004587, 0.008156, 0.010948, 0.012955, 0.015204, 0.020222, 0.024955
#*# 	  0.000690, 0.001394, 0.000932, -0.001111, -0.000722, 0.001210, 0.004073, 0.004570, -0.000009, 0.006063, 0.006449, 0.005327, 0.005482, 0.010154, 0.013802, 0.012002, 0.018510, 0.024100, 0.026515
#*# 	  0.000799, -0.003924, 0.002848, 0.001885, -0.002482, -0.001012, -0.000024, 0.003184, 0.002408, 0.001394, 0.008273, 0.004072, 0.003809, 0.008452, 0.010211, 0.014015, 0.014571, 0.019473, 0.024907
#*# 	  -0.005090, -0.004734, -0.003447, -0.003392, -0.003205, -0.000546, 0.002884, 0.002240, -0.000720, 0.003663, 0.006575, 0.005696, 0.006482, 0.009917, 0.015749, 0.012053, 0.018204, 0.023185, 0.025872
#*# 	  -0.005089, -0.007251, -0.002503, -0.000028, -0.006152, -0.002497, 0.000111, 0.000371, -0.000786, -0.000591, 0.004303, 0.003453, 0.004232, 0.008012, 0.012480, 0.014861, 0.015782, 0.019577, 0.025467
#*# 	  -0.011897, -0.010540, -0.008795, -0.006911, -0.005789, -0.004181, -0.000683, -0.001928, -0.005715, 0.000000, 0.002333, 0.002627, 0.004964, 0.011452, 0.014510, 0.011711, 0.017265, 0.024014, 0.025726
#*# 	  -0.010350, -0.012518, -0.006217, -0.006195, -0.008749, -0.006348, -0.003541, -0.003169, -0.005354, -0.005955, -0.001077, -0.004591, -0.001075, 0.005613, 0.008904, 0.012156, 0.014387, 0.020490, 0.026101
#*# 	  -0.013373, -0.009737, -0.008795, -0.006316, -0.008152, -0.006286, -0.002478, -0.004941, -0.008428, -0.005514, -0.002752, -0.001787, 0.000373, 0.005645, 0.012791, 0.011801, 0.018590, 0.024859, 0.028220
#*# 	  -0.008421, -0.009401, -0.005814, -0.003783, -0.007394, -0.005052, -0.002453, -0.003318, -0.005317, -0.007022, -0.003050, -0.004150, -0.002651, 0.003300, 0.007151, 0.011847, 0.016939, 0.022060, 0.028222
#*# 	  -0.010572, -0.007207, -0.005184, -0.003868, -0.004615, -0.003172, -0.000335, -0.002539, -0.004618, -0.002148, 0.000328, 0.002180, 0.004197, 0.010717, 0.014529, 0.015524, 0.022612, 0.030943, 0.032818
#*# 	  -0.004465, -0.006542, -0.001006, 0.002881, -0.004239, -0.000677, 0.001849, 0.001314, 0.001910, 0.001917, 0.005798, 0.004841, 0.006535, 0.011755, 0.018234, 0.019929, 0.024887, 0.031109, 0.038314
#*# 	  -0.008470, -0.003207, -0.001041, -0.000073, 0.000213, 0.001298, 0.005487, 0.005215, 0.003497, 0.008592, 0.010711, 0.011922, 0.014287, 0.019556, 0.025372, 0.025147, 0.033328, 0.040963, 0.043620
#*# 	  -0.005029, -0.005471, 0.000765, 0.004647, -0.000834, 0.004461, 0.007067, 0.009084, 0.008195, 0.009190, 0.015696, 0.012977, 0.014369, 0.019767, 0.023075, 0.026781, 0.032232, 0.039464, 0.047039
#*# 	  -0.006408, -0.002168, 0.000696, 0.001613, 0.003550, 0.008050, 0.011385, 0.011308, 0.010158, 0.016795, 0.017230, 0.018359, 0.019151, 0.024289, 0.030823, 0.029771, 0.036817, 0.046571, 0.049301
#*# 	  -0.004517, -0.004094, 0.001129, 0.006073, 0.000258, 0.004292, 0.008995, 0.012927, 0.012206, 0.013956, 0.019777, 0.015667, 0.016697, 0.024046, 0.026747, 0.029035, 0.034998, 0.042563, 0.048273
#*# x_count = 19
#*# y_count = 19
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 131.757
#*# max_x = 218.263
#*# min_y = 131.83
#*# max_y = 218.251
