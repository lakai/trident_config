
[include cartographer.cfg]
[include ebb36.cfg]
[include steppers.cfg]
[include x.cfg]
[include bedfans.cfg]
[include carto_calibrate.cfg]
[include temp.cfg]
[include motorsync.cfg]
[include mainsail.cfg]
[include KAMP_Settings.cfg]
[include timelapse.cfg]
[include macros.cfg]
#[include tmc_autotune.cfg]
[include autospeed.cfg]
[include testspeed.cfg]
[include grease.cfg]
[include stealthburner_led.cfg]
[include nis.cfg]
[include reshelper.cfg]
[include nw.cfg]

[mcu]
canbus_uuid: 0bfa866d29fd

[printer]
kinematics: corexy
max_velocity: 450
max_accel: 50000             #Max 4000
max_z_velocity: 15         #Max 15 for 12V TMC Drivers, can increase for 24V
max_z_accel: 100
minimum_cruise_ratio: 0.5				# Default 0.5
square_corner_velocity: 5.0

[input_shaper]
shaper_freq_x: 105
shaper_type_x: mzv
damping_ratio_x: 0.029
shaper_freq_y: 84.4
shaper_type_y: mzv
damping_ratio_y: 0.049

[extruder]
step_pin: ebb36: PD0
dir_pin: ebb36: PD1
#sensor_type: ATC Semitec 104GT-2
sensor_type: EPCOS 100K B57560G104F 
sensor_pin: ebb36: TH0 #PA3 
enable_pin: !ebb36: PD2
heater_pin: ebb36: HE0
##  rotation_distance = <previous_rotation_distance> * <actual_extrude_distance> / 100 8.255
#rotation_distance: 4.5449275368 # 4.63768116 #34.778 #22.225371 #22.67895 #52.558275 #52.25 #53.59 #22.6789511  #22.23 #Bondtech 5mm Drive Gears
rotation_distance: 47.088
gear_ratio: 9:1 #7.5:1 #50:10 #44:10 37:17 #50:17             # BMG Gear Ratio
microsteps: 16
full_steps_per_rotation: 200    #200 for 1.8 degree, 400 for 0.9 degree
nozzle_diameter: 0.400
filament_diameter: 1.75
max_extrude_only_distance: 101 
max_extrude_only_velocity: 120 
min_temp: -20
max_temp: 300
min_extrude_temp: 170
pressure_advance: 0.052 #0.042
pressure_advance_smooth_time: 0.03
max_extrude_cross_section: 5
#control: pid
#pid_Kp: 21.527
#pid_Ki: 1.063
#pid_Kd: 108.982
min_temp: 0
max_temp: 270

##  E0 on MOTOR6
[tmc2209 extruder]
uart_pin: ebb36: PA15
interpolate: false
run_current: 0.85
sense_resistor: 0.110
stealthchop_threshold: 0
driver_TBL: 0 
driver_HEND: 6 
driver_HSTRT: 7 
driver_TOFF: 4

[heater_bed]
heater_pin: PA3
sensor_type: Generic 3950
sensor_pin: PF3
max_power: 1.0
min_temp: 0
max_temp: 120
#control: pid
#pid_kp: 58.437
#pid_ki: 2.347
#pid_kd: 363.769

[idle_timeout]
timeout: 1800

[z_tilt]

z_positions:
   -50, 18
   175, 398
   400, 18
points:
   30, 5
   175, 295
   320, 5

speed: 300
horizontal_move_z: 10
retries: 5
retry_tolerance: 0.0025


[board_pins]
  aliases:
    # EXP1 header
    EXP1_1=PE8, EXP1_2=PE7,
    EXP1_3=PE9, EXP1_4=PE10,
    EXP1_5=PE12, EXP1_6=PE13,    # Slot in the socket on this side
    EXP1_7=PE14, EXP1_8=PE15,
    EXP1_9=<GND>, EXP1_10=<5V>,
  
    # EXP2 header
    EXP2_1=PA6, EXP2_2=PA5,
    EXP2_3=PB1, EXP2_4=PA4,
    EXP2_5=PB2, EXP2_6=PA7,      # Slot in the socket on this side
    EXP2_7=PC15, EXP2_8=<RST>,
    EXP2_9=<GND>, EXP2_10=<5V>


[gcode_macro PRINT_START]
gcode:
    STATUS_HOMING
    LOWERCURRENT
    G28
    RESETCURRENT
    SYNC_MOTORS
    STATUS_READY
    BED_MESH_CLEAR
    BED_MESH_CALIBRATE
    CARTOGRAPHER_TOUCH
    M190 S{ params.BED }       ; Wait for bed to get to target temperature.
    M117 Preheating nozzle
    M109 S150                  ; Wait for nozzle to heat to 150C - soften filament, but no oozing.
    M107                       ; Print fan off
    #G1 X175 Y175 Z50 F5000.0
    STATUS_HEATING
    M117 Heating nozzle
    M109 S{ params.EXTRUDER }  ; Wait for nozzle to get to target temperature.
    G90                 ; Absolute coordinates.
    M83                 ; Relative extruder mode.
    STATUS_CLEANING
    #clean_nozzle
    STATUS_READY
    set_nozzle_leds_on
    #SET_FAN_SPEED FAN=Nevermore SPEED=0.7
    BED_MESH_PROFILE LOAD="default"    
    # G1 Z20 F3000                   ; move nozzle away from bed
    # G1 X10 Y20 Z0.3 F5000.0 ; move to start-line position
    # G1 X10 Y200.0 Z0.3 F1500.0 E15 ; draw 1st line
    # G1 X11 Y200.0 Z0.3 F5000.0 ; move to side a little
    # G1 X11 Y20 Z0.3 F1500.0 E30 ; draw 2nd line
    # G1 E27 F3000 ; retract filament 3mm
    # G92 E0 ; reset extruder
    # G1 Z1.0 F3000 ; move z up little to prevent scratching of surface
    LINE_PURGE

[gcode_macro PRINT_END]
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 2, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END

    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-11.0 F3600                 ; retract filament
    TURN_OFF_HEATERS
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    BED_MESH_CLEAR
    SET_PIN PIN=caselight VALUE=0.00
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END MOVE=0

[danger_options]

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 21.171
#*# pid_ki = 2.776
#*# pid_kd = 40.360
#*# pid_version = 1
#*# pid_target = 260.00
#*# pid_tolerance = 0.0200
#*#
#*# [motors_sync]
#*# steps_model_x = quadratic,
#*# 	  -970.6457968983249,
#*# 	  25991.84731691398,
#*# 	  2115.5684230633683
#*# steps_model_y = quadratic,
#*# 	  -970.6457968983249,
#*# 	  25991.84731691398,
#*# 	  2115.5684230633683
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.680
#*# pid_ki = 1.848
#*# pid_kd = 434.664
#*# pid_version = 1
#*# pid_target = 110.00
#*# pid_tolerance = 0.0200
#*#
#*# [scanner model default]
#*# model_coef = 1.323037822503541,
#*# 	1.7485083404142936,
#*# 	0.7822553202173664,
#*# 	0.36843496557194017,
#*# 	0.3482072128995692,
#*# 	0.4367981721464956,
#*# 	-0.15056931786425573,
#*# 	-0.39274613623475696,
#*# 	0.24745569944124496,
#*# 	0.29127781246524803
#*# model_domain = 3.1747628564709233e-07,3.33795980105204e-07
#*# model_range = 0.100000,5.000000
#*# model_temp = 20.201706
#*# model_offset = 0.00000
#*# model_mode = touch
#*# model_fw_version = CARTOGRAPHER 5.0.0
#*#
#*# [scanner]
#*# mode = touch
#*# scanner_touch_threshold = 1500
#*# scanner_touch_speed = 3
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	0.027042, 0.015713, 0.011848, 0.009566, 0.005000, -0.002980, -0.009724, -0.013152, -0.015831, -0.015809, -0.020089, -0.026578, -0.026500, -0.021633, -0.017784
#*# 	0.033558, 0.026642, 0.020559, 0.014945, 0.009508, 0.004922, -0.001282, -0.005505, -0.007723, -0.011089, -0.017334, -0.020397, -0.018216, -0.013412, -0.013959
#*# 	0.038590, 0.033621, 0.030965, 0.025680, 0.015725, 0.009675, 0.006716, 0.001774, -0.001890, -0.008572, -0.014216, -0.016224, -0.016279, -0.015624, -0.015177
#*# 	0.045731, 0.039290, 0.032610, 0.027100, 0.024259, 0.018427, 0.010634, 0.002801, -0.000703, -0.004494, -0.013798, -0.016218, -0.016433, -0.011419, -0.013312
#*# 	0.047294, 0.043247, 0.039944, 0.034894, 0.028929, 0.021718, 0.013876, 0.007634, 0.002259, -0.002880, -0.010179, -0.014866, -0.017536, -0.017452, -0.016568
#*# 	0.043945, 0.043243, 0.039129, 0.033162, 0.029614, 0.021015, 0.015514, 0.006192, 0.000991, -0.003951, -0.010940, -0.015638, -0.018689, -0.015021, -0.016340
#*# 	0.041230, 0.038976, 0.040080, 0.037486, 0.029247, 0.021212, 0.013368, 0.007877, 0.001061, -0.006418, -0.012959, -0.016316, -0.018169, -0.021101, -0.020955
#*# 	0.036232, 0.033912, 0.031595, 0.029106, 0.027068, 0.018178, 0.009501, 0.000000, -0.003791, -0.010072, -0.018725, -0.022746, -0.023160, -0.019054, -0.023659
#*# 	0.029390, 0.029539, 0.029962, 0.029963, 0.025713, 0.015466, 0.008677, 0.001515, -0.003933, -0.009925, -0.016139, -0.023725, -0.024812, -0.023507, -0.025354
#*# 	0.022216, 0.023383, 0.023521, 0.021424, 0.019646, 0.012180, 0.006686, -0.002741, -0.008655, -0.012655, -0.020574, -0.024763, -0.026519, -0.019390, -0.020154
#*# 	0.010120, 0.013988, 0.018443, 0.016115, 0.013763, 0.007222, 0.001813, -0.005674, -0.011046, -0.015881, -0.021708, -0.025553, -0.026644, -0.024468, -0.023233
#*# 	0.003508, 0.007455, 0.008186, 0.008298, 0.007741, 0.002750, -0.003561, -0.009588, -0.013536, -0.018842, -0.025546, -0.025870, -0.026209, -0.020285, -0.018783
#*# 	-0.002555, 0.002760, 0.009416, 0.011580, 0.009251, 0.003694, -0.001169, -0.007613, -0.013024, -0.016907, -0.021883, -0.023408, -0.020955, -0.020592, -0.017629
#*# 	-0.001407, 0.004819, 0.006037, 0.005060, 0.004543, 0.004689, -0.000694, -0.010596, -0.016408, -0.018480, -0.021310, -0.021206, -0.021694, -0.013392, -0.012674
#*# 	-0.005853, -0.001711, 0.004670, 0.008633, 0.006471, 0.002371, -0.003766, -0.010489, -0.014016, -0.014297, -0.019555, -0.021867, -0.020684, -0.016308, -0.013552
#*# x_count = 15
#*# y_count = 15
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 141.999968
#*# max_x = 207.999968
#*# min_y = 142.027408
#*# max_y = 207.972592
